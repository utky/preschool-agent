version: 2

models:
  - name: dim_documents
    description: "文書メタデータのディメンションテーブル"
    columns:
      - name: document_id
        description: "文書ID（URIのMD5ハッシュ）"
        data_tests:
          - unique
          - not_null
      - name: uri
        description: "GCS URI"
        data_tests:
          - unique
          - not_null
      - name: title
        description: "文書タイトル（GCSメタデータのoriginal-filenameをURLデコード、フォールバック: URI末尾）"
        data_tests:
          - not_null
      - name: document_type
        description: "文書種別（Slice 6で分類実装予定、暫定NULL）"
      - name: publish_date
        description: "発行日（Slice 6で抽出実装予定、暫定NULL）"
      - name: content_type
        description: "MIMEタイプ"
      - name: size
        description: "ファイルサイズ（バイト）"
      - name: total_chunks
        description: "チャンク総数"
      - name: updated_at
        description: "GCSオブジェクトの最終更新日時"

  - name: fct_events
    description: "PDFから抽出したイベント・行事予定のファクトテーブル"
    columns:
      - name: event_id
        description: "イベントID（document_id + event_date + event_titleのMD5ハッシュ）"
        data_tests:
          - unique
          - not_null
      - name: document_id
        description: "抽出元文書ID"
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_documents')
                field: document_id
      - name: event_date
        description: "イベント日付（DATE型）"
        data_tests:
          - not_null
      - name: event_time
        description: "イベント開始時刻（TIME型、HH:MM形式、時刻が不明な場合はNULL）"
      - name: event_title
        description: "イベントタイトル"
        data_tests:
          - not_null
      - name: event_description
        description: "イベント詳細説明"
        data_tests:
          - not_null
      - name: extracted_at
        description: "LLM抽出日時"
        data_tests:
          - not_null

  - name: fct_document_chunks
    description: "文書チャンクのファクトテーブル（RAG用）"
    columns:
      - name: chunk_id
        description: "チャンクID"
        data_tests:
          - unique
          - not_null
      - name: document_id
        description: "文書ID"
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_documents')
                field: document_id
      - name: chunk_index
        description: "チャンクの順序インデックス"
        data_tests:
          - not_null
      - name: chunk_text
        description: "チャンクテキスト"
        data_tests:
          - not_null
      - name: chunk_embedding
        description: "768次元のベクトル埋め込み（FLOAT64配列、COSINE Vector Index付き）"
        data_tests:
          - not_null
      - name: title
        description: "文書タイトル（冗長: RAG用）"
      - name: document_type
        description: "文書種別（冗長: RAG用）"
      - name: publish_date
        description: "発行日（冗長: RAG用）"
