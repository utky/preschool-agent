# 要件
幼稚園から送付されるお知らせのPDFを知識として蓄積し各種作業をことができるAIエージェントを構築します。すなわちPDFに由来する知識を使ったRAGを用いたAIエージェントです。

## ユースケース
幼稚園から送付された資料の情報をもとに以下のユースケースをサポートする。

1. 資料に記載された予定や提出依頼をGoogle Calendarへと自動登録する。
2. 資料に記載された写真抽出し画像として閲覧可能とする。
3. 資料に対する自然言語での問い合わせに応答する。
4. 資料をもとに直近で必要なアクションを提示しサポートする

## 機能
以下のような機能を持つ。

- A) 資料のロード
- B) 資料の解析
    - テキスト解析
    - 画像解析
- C) 資料にもとづく定型処理の自動化
    - カレンダー登録
- D) 資料への問い合わせ処理
- E) 資料から抽出された予定・アクションの表示
- F) 予定のカレンダー登録

## 構成
機能は以下の構成要素により実現される。

### バックエンド:
- Google Driveの所定のフォルダに配置されたPDFファイルを定期的に監視する
- Google Driveの所定のフォルダに新しいファイルが配置されたらそれをCloud Storageにコピーする
- Cloud StorageのPDFファイルの内容を解析し構造化して抽出しBigQueryテーブルに保存する
- PDFに含まれる写真は個別にCloud Storageに非構造化データとして保存する
- 解析結果として保存したデータに予定や期限に関するものがあれば承認待ちリストにいれる
- 予定の承認が得られればGoogleカレンダーに登録する

### フロントエンド:
- BigQueryテーブルを検索知識として以下の問い合わせに柔軟に応答するAIエージェント
    - 将来の予定や提出物などを検索する
    - 将来の予定や提出物に関する情報をカレンダーに登録
    - 抽出された写真はギャラリー化して表示する

## 利用者と認証
家族数名。認証には **Auth.js (NextAuth.js) と Google プロバイダー** を利用し、許可されたGoogleアカウントを持つユーザーのみがアプリケーションにアクセスできる形とする。

本アプリケーションは個人的なツールであり、利用者は限定的である。全ての利用者が同じ権限を持つことを想定しているため、ロールベースアクセス制御（RBAC）のような複雑な認可機能は導入しない。

## 入力データ
幼稚園から定期的に配布されるPDFファイル。

- journal
- photo album
- monthly announcement
- monthly lunch schedule
- monthly lunch info

### journal:
不定期刊行のお知らせなどが掲載されている。

```
${title} No.${記事番号} ${和暦} ${year}年 ${month} 月 ${day} 日 (${weekday})
${section}
${content}
${section}
${content}
```

### photo album:
不定期刊行の写真がメインの記事。

構造は不定形。

- 横長のページ
- ページ左上
    - タイトル
    - 執筆者
    - 和暦
    - 園名
- タイル状にセクションが配置される
- タイル状に写真が配置される
- ページ右下
    - 保育内容表

### monthly announcement:
月次で発行される周知事項。

1ページで2アップの構成。
以下の順でコンテンツが配置されている。

- タイトル
- 序文
- スケジュール
- `★` で始まるセクション
- 月度の保育目標

### monthly lunch schedule:
月次給食献立表。

- 刊行月度
- タイトル
- 園名
- 献立表
- 平均栄養価表

### monthly lunch info:
月次の給食に関するお知らせ。

- タイトル
- 刊行月度
- 執筆者
- 序文
- コンテンツ(複数セクション)

## Google Drive監視
### 監視間隔
PDFが発行される周期が1ファイル/週なので。
1回/時で問題ない。

### 取り込み条件
ユーザは指定されたGoogle DriveのフォルダにPDFファイルをアップロードする。
システムはこのフォルダにあるファイルと取り込み済みデータの差分を定期チェックし、「ドライブある かつ データベースにない」ファイルを処理対象とする。

条件を整理すると以下。

- ドライブにない && データベースにない → 処理対象なし。何もしない。
- ドライブにある && データベースにない → 新着。取り込み対象。
- ドライブにない && データベースにある → 取り込み済み。何もしない。
- ドライブにある && データベースにある → 取り込み済み。何もしない。

## インフラストラクチャ
OpenTofuを用いてGoogle Cloudの構成管理を行います。

- **状態管理**: 状態ファイル (.tfstate) の管理にはGoogle Cloud Storageバックエンドを利用し、チームでの安全な状態共有とロックを実現します。
- **ディレクトリ構成**: 機能のまとまりでモジュールを分割し、一般的なベストプラクティスに従ったディレクトリ構造を採用します。
- **CI/CD認証**: CI/CDパイプラインからGoogle Cloudへの認証には、Workload Identity連携を利用して、セキュアなアクセスを実現します。
- **アプリケーション認証**: 認証に必要なGoogle OAuthクライアントIDや関連シークレットは、OpenTofuでコードとして管理し、Secret Managerを通じてアプリケーションに提供します。

## CI/CD
個人プロジェクトとして、ステージング環境を介さずに本番環境へ直接デプロイするシンプルな運用を前提とします。
ただし、安全性を確保するため、本番環境への変更適用前には必ず手動での承認プロセスを挟みます。
CI/CDツールにはGitHub Actionsを想定しています。

### Pull Requestでの変更内容の確認 (CI)
`feature`ブランチから`main`ブランチへのPull Requestを作成した際に、以下のジョブを自動実行します。

- **ユニットテスト:** バックエンドとフロントエンドのユニットテストを実行します。
- **`tofu plan`:** 本番環境に対する`tofu plan`を実行し、インフラの変更計画をPull Request上にコメントとして投稿します。

これにより、マージ前にコードの品質とインフラの変更内容をレビューできます。

### mainブランチへのマージと手動承認による本番デプロイ (CD)
Pull Requestを`main`ブランチにマージすると、デプロイワークフローが開始されます。

- **トリガー:** `main`ブランチへのPush
- **実行ジョブ:**
    1. **イメージビルド:** アプリケーションのDockerイメージをビルドし、Google Artifact Registryにプッシュします。
    2. **`tofu plan`:** `apply`直前の最終的な変更計画を生成します。
    3. **手動承認:** パイプラインを一時停止し、手動での承認クリックを要求します。これにより、意図しないデプロイを防ぎます。
    4. **`tofu apply`:** 承認が行われた場合にのみ、`tofu apply`を実行して本番環境に変更を適用します。

## 技術的制約
- TypeScript で実装すること
- AIエージェントフレームワーク: Mastraを利用すること
- Web UI フレームワーク: Next.jsを利用すること
- 開発ツール: npm, tenv, opentofu を利用すること
- エディタはVSCodeを前提とした設定ファイルにすること
- コーディングエージェントはGemini CLIとすること
- モバイルファーストのWeb UIデザインとすること
